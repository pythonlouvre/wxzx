---
layout: post
title: 样本库源代码分析
tags: 样本库
---


[TOC]

# 整体结构

## Struts配置文件分类

res目录下,对应的业务大类:

### acl—访问权限控制
--根据dataType和dataId获取每行数据的操作
    aclJson
        1. getAclJson
        2. getOperateAclJson
### config--系统配置
    1. config
    2. configJson
### container--样品容器
    1. containerJson
    2. container
### data--问卷答案(Answer)
    1. dataJson
    2. data
### dataExport--到处问卷数据
    1. dataExportJson
    2. dataExport
### error--出错跳转
    1. error
### followUp—随访
    1. followUpJson
    2. followUp
### interceptor--拦截器：
    1. 用户数量拦截器：当前会话用户的用户组(机构)下创建的用户数量不能超过1000个
    2. 用户组数量拦截器：当前会话的用户组下创建的子用户组数量不能超过3000个。
    3. 样品组数量拦截器：当前会话的用户组关联的样品组数量不能超过1000个。
    4. 冰箱数量拦截器：当前会话的用户组创建的冰箱数量不能超过1000个。
```xml
<global-results>
    <result name="validate_no_pass" type="json">
        <param name="root">message</param>
    </result>
</global-results>
```
### log--日志
    1. logJson
    2. log
### order--样品转移单
    1. orderJson
    2. order
### pad--平板容器
    1. padJson
    2. pad
### patient--只有拦截器
    1. patientJson
    2. patient
### question--问题
    1. questionJson
    2. question
### questionnaire—问卷
    1. questionnaireJson
    2. questionnaire
### schedule--solr索引更新
    1. scheduleJson
    2. schedule
### statistics--统计报表
    1. statisticsJson
    2. statistics
### tissue—样品
    1. tissueJson
    2. tissue
### tissueAlarm--警告
    1. tissueAlarmJson
    2. tissueAlarm
### tissueSource--样品源
    1. tissueSourceJson
    2. tissueSource
### user--用户
    1. userJson
    2. user
### userLogin—用户登入登出几session过期验证action
    1. userLoginJson
    2. userLogin
### struts.xml
—包含其他struts文件的总的struts文件，同时包含struts的参数配置信息



## Spring配置文件
业务分类同Struts
### applicationContext.xml
1. DataSource
    连接池：DBCP----建议采用Tomcat JDBC Pool或者Druid[阿里，带SQL性能监控功能]
    DBCP,C3P0,Tomcat JDBC Pool性能及稳定性测试:
        http://www.open-open.com/lib/view/open1329182303124.html
2. Hibernate Session Factory
3. Hibernate Transaction Manager
4. Transaction Proxy Factory                配置事务传播特性
5. Hibernate Interceptor
6. BeanNameAutoProxyCreator                 bean后处理器，为bean添加代理
    1. 用户日志
        拦截的业务类：
        >userBusiness

        拦截的方法名：
        >saveOrUpdateQueInstanceAnswer
        
        afterReturning内容：
        >保存日志数据至log表
        
    2. 样品源日志
        拦截的业务类：
        >tissueSourceBusiness

        拦截的方法名：
        >saveOrUpdateQueInstanceAnswer
        
        afterReturning内容：
        >保存日志数据至log表
        
    3. 样品复份日志
        拦截的业务类：
        >tissueBusiness
        >tissueOutBusiness

        拦截的方法名：
        >saveOrUpdateQueInstanceAnswer
        
        afterReturning内容：
        >保存日志数据至log表
        
    4. 问卷信息日志
        拦截的业务类：
        >dataBusiness

        拦截的方法名：
        >saveOrUpdateQueInstanceAnswer
        
        afterReturning内容：
        >保存日志数据至log表
        
    5. 容器计算
        拦截的业务类：
        >tissueBussiness
        >tissueOutBusiness
        >containerBusiness
        >shiftOrderBusiness
        
        拦截的方法名：
        >saveContainer                  
        >delContainer
        >updateContainer
        >addCopyContainer
        >saveTissueAndTissueBackup
        >saveTissueBackupIn
        >deleteTissueBackupByTissueBackupIds
        >addOrderWithTissueOut
        >updateTissueBackupByTissueBackupId
        >saveTissueBackupRevertOrder
        >saveShiftOrderWithTissue
        >updateShiftTissueBackup
        >saveShiftOrderWithContainer
        >updateShiftContainer

        afterReturning内容：
        >tubeCount ＝           当前容器下的各个子容器的containerSubContainerCount
        >tissueBuckUpCount =    当前容器下的各个子容器的containerTissueCount
        递归计算至冰箱

## 命名规范

1、action名:驼峰命名法

namespace分json和非json两部分，如：

config

/config

/configJson



## 代码目录结构
src
res
WebContent
├── WEB-INF
│   ├── classes
│   ├── lib
│   ├── tlds
│   └── web.xml
├── applet
│   └── cmdPrint
├── common
│   ├── base.jsp                    
│   └── taglibs.jsp
├── conf
├── css
│   ├── barcodeCheck
│   ├── base.css
│   ├── cacheTissueCreate
│   ├── common
│   ├── container
│   ├── data
│   ├── easyui
│   ├── images
│   ├── layout.css
│   ├── login
│   ├── menuIcon
│   ├── menuIcon.css
│   ├── mobile
│   ├── printerConfig
│   ├── question
│   ├── questionnaire
│   ├── rj.css
│   ├── tissue
│   └── user
├── download
├── file
│   └── image
├── images
│   ├── barcodeCheck
│   ├── button
│   ├── cacheTissueCreate
│   ├── common
│   ├── container
│   ├── data
│   ├── layout
│   ├── login
│   ├── mobile
│   ├── printerConfig
│   ├── questionnaire
│   ├── temp
│   ├── tissue
│   └── tissue_type
├── index.jsp
├── js
│   ├── acl
│   ├── arrayList.js
│   ├── common
│   ├── config
│   ├── container
│   ├── data
│   ├── followUp
│   ├── layout
│   ├── log
│   ├── mobile
│   ├── order
│   ├── question
│   ├── questionnaire
│   ├── statistics
│   ├── tissue
│   ├── tissueSource
│   └── user
├── log
├── login.jsp
├── page
│   ├── acl
│   ├── config
│   ├── container
│   ├── data
│   ├── error
│   ├── followUp
│   ├── help
│   ├── layout
│   ├── log
│   ├── mobile
│   ├── order
│   ├── question
│   ├── questionnaire
│   ├── statistics
│   ├── tissue
│   ├── tissueSource
│   └── user
├── secondaryIndex.jsp
└── upload
    └── temp.txt



## Dao层基础类中的预定义的操作

* delete(T)—删除对象记录
* deleteAll(Collection)--批量删除对象记录
* deleteByKey(PK id)—通过主键删除对象记录
* findById(PK)—通过主键查找对象记录
* findByProperty(String propertyName, Object value)--查找对象属性的值？
* findAll()—查询表中所有数据
* merge(T detachedInstance ) —?
* attachClean(T instance )—?
* find(String queryString )—?
* find(String queryString, Object[] values )—?
* findByNamedParam(String queryString, String[] paramNames, Object[] values)
* findByNamedQuery(String queryName ) —?
* findByNamedQuery(String queryName, Object[] values )—?
* findByNamedQueryAndNamedParam(String queryName, String[] paramNames, Object[] values )—?
* flush()—?
* initialize(Object proxy ) —?
* save(T entity )—保存实体，执行insert
* saveOrUpdate(T entity )—？
* update(T entity )—？
* load(PK id )—？
* findObjectByParentObject(Object parentObject, String childName )—？
* findObjectWithNewSession(Object parentObject, String id )—？

## 关闭Solr

config.properties:

enableDebugSolrForbidden = true

## EasyUI

1. 获取下拉框中的当前值:$(‘#id').combobox('getValue')
2. DataGrid根据id寻找匹配行:
3. 下拉框填充JSON数据:
```javascript
$a.combobox({
            url : ctx + '/tissueSourceJson/getTSCaseListByTsIdWithJson.action?tsId=' + $('#tissueSourceId').val(),
            valueField : 'tsCaseId',
            textField : 'tsCaseShow',
            required : true,
            editable : false
        });
```
4. easyui-validatebox文本校验框的使用:

内置的validType：
```html
<input id="ipPsName" class="easyui-validatebox" style="width:100px;" required="true" validType="length[1,20]" type="text"/>
```
自定义的validType：
```javascript
validType="myfunc[param0, param1,param2]"

扩展函数如下：

$.extend($.fn.validatebox.defaults.rules, {
        myfunc: {
            validator: function(value, param){

                  param[0];//param0

                  param[1];//param1

                  param[2];//param1

                  rs = true || false;//'what you validation';

                 //@todo.....
                 return rs ;
            },
            message: '请输入长度大于 {0} 的数据.'
        }

}
```
使用js对输入框增加valid校验:
```javascript
$(custromRuleInput).validatebox({
	required : true,
	validType : 'length['+criRuleLength+','+criRuleLength+']',
	invalidMessage : '输入内容长度必须为' + criRuleLength
});
```

5. EasyUI Datagrid的通用JSP页面结构

>1. 引入数据装载的js文件
>2. EasyUI datagrid的主结构
>3. EasyUI的新增弹窗框的表单字段easyui-validatebox校验结构[初始隐藏]
>4. EasyUI的编辑弹出框的表单字段easyui-validatebox校验结构[初始隐藏]

```html
    <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
     <%@ include file="../../common/taglibs.jsp"%>
     <%@ include file="../../common/base.jsp"%>
     <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "[http://www.w3.org/TR/html4/loose.dtd](http://www.w3.org/TR/html4/loose.dtd)">
     <html>
     <head>
     <title>标签管理</title>
     <script type="text/javascript" src="${ctx}/js/config/viewLabelList.js"></script>
     </head>
     <body class="easyui-layout">
     <div region="center" style="padding:5px;">
     <div id="divToolbar" style="padding:5px; height:auto; font-size:12px;">
     <table>
     </table>
     <auth:authorize ifAnyGranted="submit_printer_config">
     <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="addLabel();">添加</a>
     </auth:authorize>
     </div>
     <table id="tbLabel"></table>
     </div>
     <div id="divAddLabel" overflow="hidden">
     <form id="fmAddLabel" method="#">
     <table>
     <tr>
     <td>标签类型:</td>
     <td><input id="ipLabelType" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelType"/></td>
     </tr>
     <tr>
     <td>标签名称:</td>
     <td><input id="ipLabelName" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelName"/></td>
     </tr>
     <tr>
     <td>标签宽度:</td>
     <td><input id="ipLabelWidth" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelWidth"/></td>
     </tr>
     <tr>
     <td>标标签高度:</td>
     <td><input id="ipLabelHeight" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelHeight"/></td>
     </tr>
     <tr>
     <td>标签水平间隙:</td>
     <td><input id="ipLabelHgap" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelHgap"/></td>
     </tr>
     <tr>
     <td>标签垂直间隙:</td>
     <td><input id="ipLabelVgap" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelVgap"/></td>
     </tr>
     <tr>
     <td>标签列数:</td>
     <td><input id="ipLabelColumn" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelColumn"/></td>
     </tr>
     </table>
     </form>
     </div>
     <div id="divEditLabel" overflow="hidden">
     <form id="fmEditLabel" method="#">
     <input id="ipLabelId" type="hidden" name="labelVO.labelId"/>
     <table>
     <tr>
     <td>标签类型:</td>
     <td><input id="ipLabelType" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelType"/></td>
     </tr>
     <tr>
     <td>标签名称:</td>
     <td><input id="ipLabelName" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelName"/></td>
     </tr>
     <tr>
     <td>标签宽度:</td>
     <td><input id="ipLabelWidth" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelWidth"/></td>
     </tr>
     <tr>
     <td>标标签高度:</td>
     <td><input id="ipLabelHeight" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelHeight"/></td>
     </tr>
     <tr>
     <td>标签水平间隙:</td>
     <td><input id="ipLabelHgap" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelHgap"/></td>
     </tr>
     <tr>
     <td>标签垂直间隙:</td>
     <td><input id="ipLabelVgap" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelVgap"/></td>
     </tr>
     <tr>
     <td>标签列数:</td>
     <td><input id="ipLabelColumn" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="labelVO.labelColumn"/></td>
     </tr>
     </table>
     </form>
     </div>
     </body>
    </html>
```

## 权限控制--业务功能[菜单+按钮的显示和隐藏]

<auth:authorize>  
AuthValidatorTag.java->doStartTag

1. operate表定义操作权限—>在初始化脚本中新增

    INSERT INTO `operate` VALUES ('917', '143', 'tissue_in_library_receipt_detail','入库单据明细', 'menu', 0); —operate_id只要不同即可,parent_id未父操作，显示权限列表的时候显示树形结构。
    

1. role_oper表定义某个角色关联哪些操作

role_oper表的操作sql可以通过在页面操作完成之后导出即可

## WebService

1. 对外服务类:org.scbit.tissuebank.webservice.resources

入门教程：[http://www.cnblogs.com/yjmyzz/p/javaee-jax-rs-tutorial.html]

- - -

# 增删改查

--[以系统设置->打印机管理->标签管理为例]

## 增

- - -

**一、Struts配置及前端调用**

Struts:

    <action name="addLabelWithJson" class="org.scbit.tissuebank.config.action.LabelAction" method="addLabelWithJson">
         <result name="success" type="json">
              <param name="root">message</param>
         </result>
    </action>
    

​

前端调用:

     // 标签添加对话框  
    

$('#divAddLabel').dialog({  
modal:true,  
title:"添加标签",  
iconCls:'icon-save',  
resizable:false,  
width:300,  
height:300,  
closed:'true',  
buttons:[{  
text:"确定",  
iconCls:'icon-ok',  
handler:function(){  
if ($('#fmAddLabel').form('validate')) {  
$.ajax({  
url:ctx+'/configJson/addLabelWithJson.action',  
type:'post',  
dateType:'json',  
data:$('#fmAddLabel').serialize(),  
success: function(data){  
$('#divAddLabel').dialog('close');  
top.showSystemMessage(data.status,data.message);  
$('#tbLabel').datagrid('load');  
}  
});  
}  
}  
},{  
text:"取消",  
iconCls:'icon-cancel',  
handler:function(){  
$('#divAddLabel').dialog('close');  
}  
}]  
});

​

**二、Action、Service、Dao层**

Action层->:

    public String addLabelWithJson() {
         try {
         BusinessResult br = printerBusiness.saveLabel(labelVO);
         if (BusinessResult.STATUS_SUCCESS == br.getStatus()) {
         setMessage(MESSAGE_SUCCESS, "添加成功！");
         } else {
             if (br.getErrors().size() > 0) {
             String[] messageShows = ResourceUtil.getMessageShowsByBusinessResultCodes(br.getErrors().keySet());
             setMessage(MESSAGE_ERROR, messageShows); // 已知错误
             } else {
             setMessage(MESSAGE_ERROR, "未知错误！");
             }
         }
     } catch (Exception e) {
     e.printStackTrace();
     setMessage(MESSAGE_EXP_ERROR, "添加失败！");
                 recordExceptionLog("添加失败！", e);
     }
             return SUCCESS;
        }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->

    @Override
     public BusinessResult saveLabel(LabelVO labelVO) {
     BusinessResult br = new BusinessResult();
     Label label = convertLabelVOToLabel(labelVO);
     label = labelService.saveLabel(label);
     labelVO = (LabelVO) findLabelByLabelId(label.getLabelId()).getData();
     br.setData(labelVO);
     br.setStatus(BusinessResult.STATUS_SUCCESS);
     return br;
    }
    Service层->
    public Label saveLabel(Label label) {
         return labelDAO.save(label);
        }
    

​

Dao层->

自动继承自基础Dao类

## 删

- - -

**一、Struts配置及前端调用:**

Struts:

    <action name="deleteLabelWithJson" class="org.scbit.tissuebank.config.action.LabelAction" method="deleteLabelWithJson">
     <result name="success" type="json">
     <param name="root">message</param>
    </result>
    </action>
    

​

前端调用:

在datagrid的id列的column中的formatter中生成对应的调用代码[删除单个]

    function deleteLabel(id){
     $.messager.confirm('提示','确定要删除吗？',function(flag){
     if(flag){
     $.ajax({
     url: ctx + '/configJson/deleteLabelWithJson.action?labelId=' + id,
     type: 'post',
     dataType: 'json',
     success: function(data){
     top.showSystemMessage(data.status, data.message);
     $('#tbLabel').datagrid('load');
     }
     });
     }
     });
    }
    

​

**二、Action、Service、Dao层**

Action层->:

     public String deleteLabelWithJson() {
         try {
         BusinessResult br = printerBusiness.deleteLabelByLabelId(new String[]{labelId});
         if (BusinessResult.STATUS_SUCCESS == br.getStatus()) {
         setMessage(MESSAGE_SUCCESS, "删除成功！");
         } else {
             if (br.getErrors().size() > 0) {
             String[] messageShows = ResourceUtil.getMessageShowsByBusinessResultCodes(br.getErrors().keySet());
             setMessage(MESSAGE_ERROR, messageShows); // 已知错误
             } else {
             setMessage(MESSAGE_ERROR, "未知错误！");
             }
         }
     } catch (Exception e) {
     e.printStackTrace();
     setMessage(MESSAGE_EXP_ERROR, "删除失败！");
                 recordExceptionLog("删除失败！", e);
     }
             return SUCCESS;
        }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的status状态->

    @Override
     public BusinessResult deleteLabelByLabelId(String[] ids) {
     BusinessResult br = new BusinessResult();
     labelService.deleteLabelByLabelId(ids);
     br.setStatus(BusinessResult.STATUS_SUCCESS);
     return br;
    }
    Service层->
    public void deleteLabelByLabelId(String[] ids) {
             if (ids != null) {
                 Label label = null;
                 for (int i = 0; i < ids.length; i++) {
                 label = labelDAO.findById(ids[i]);
                     if (label != null) {
                     labelDAO.delete(label);
                     }
                 }
             }
         }
    

​

Dao层->

自动继承自基础Dao类

## 改

- - -

**一、Struts配置及前端调用:**

Struts:

    <action name="editLabelWithJson" class="org.scbit.tissuebank.config.action.LabelAction" method="editLabelWithJson">
     <result name="success" type="json">
     <param name="root">message</param>
    </result>
    </action>
    

​

前端调用:

    $('#divEditLabel').dialog({
     modal:true,
     title:"编辑标签",
     iconCls:'icon-edit',
     resizable:false,
     width:300,
     closed:'true',
     height:300,
     buttons:[{
     text:"确定",
     iconCls:'icon-ok',
     handler:function(){
     if ($('#fmEditLabel').form('validate')) {
     $.ajax({
     url:ctx+'/configJson/editLabelWithJson.action',
     type:'post',
     dateType:'json',
     data:$('#fmEditLabel').serialize(),
     success: function(data){
     $('#divEditLabel').dialog('close');
     top.showSystemMessage(data.status,data.message);
     $('#tbLabel').datagrid('load');
     }
     });
     }
     }
     },{
     text:"取消",
     iconCls:'icon-cancel',
     handler:function(){
     $('#divEditLabel').dialog('close');
     }
     }]
    });
    

​

**二、Action、Service、Dao层**

Action层->:

     public String editLabelWithJson() {
         try {
         BusinessResult br = printerBusiness.updateLabel(labelVO);
         if (BusinessResult.STATUS_SUCCESS == br.getStatus()) {
         setMessage(MESSAGE_SUCCESS, "修改成功！");
         } else {
             if (br.getErrors().size() > 0) {
             String[] messageShows = ResourceUtil.getMessageShowsByBusinessResultCodes(br.getErrors().keySet());
             setMessage(MESSAGE_ERROR, messageShows); // 已知错误
             } else {
             setMessage(MESSAGE_ERROR, "未知错误！");
             }
         }
     } catch (Exception e) {
     e.printStackTrace();
     setMessage(MESSAGE_EXP_ERROR, "修改失败！");
                 recordExceptionLog("修改失败！", e);
     }
             return SUCCESS;
        }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->

    @Override
     public BusinessResult updateLabel(LabelVO labelVO) {
     BusinessResult br = new BusinessResult();
     Label label = labelService.findLabelByLabelId(labelVO.getLabelId());
     OperateUtil.modifyObject(label, labelVO);
     labelVO = (LabelVO) findLabelByLabelId(labelVO.getLabelId()).getData();
     br.setData(labelVO);
     br.setStatus(BusinessResult.STATUS_SUCCESS);
     return br;
    }
    

​

Service层->

      public Label findLabelByLabelId(String id) {
             return labelDAO.findById(id);
        }
    

​

Dao层->

自动继承自基础Dao类

## 查

- - -

### 查询分页列表

**一、Struts配置及前端调用**

Struts:

    <action name="getLabelListWithJson" class="org.scbit.tissuebank.config.action.LabelAction" method="getLabelListWithJson">
    <result name="success" type="json">
     <param name="root">jsonObjectResult</param>
    </result>
    </action>
    

​

**前端调用:**

    $('#tbLabel').datagrid({
     url: ctx + '/configJson/getLabelListWithJson.action',
     idField: 'labelId',
     toolbar: '#divToolbar',
     iconCls: 'icon-save',
     fit: true,
     nowrap: false,
    striped: true,
    collapsible: true,   
    singleSelect: true,  //单选
     fitColumns: true,
     rownumbers: true,
     pagination: true,
         pageSize: 100,
         pageList: [20,40,60,80,100],
     columns: [[
                 {field:'labelType',title:'标签类型',width:60,sortable:false},
                 {field:'labelName',title:'标签名称',width:60,sortable:false},
                 {field:'labelWidth',title:'标签宽度',width:60,sortable:false},
                 {field:'labelHeight',title:'标签高度',width:60,sortable:false},
                 {field:'labelHgap',title:'标签水平间隙',width:60,sortable:false},
                 {field:'labelVgap',title:'标签垂直间隙',width:60,sortable:false},
                 {field:'labelColumn',title:'标签列数',width:60,sortable:false},
                 {field:'labelId',title:'操作',width:200,align:'left', rowspan:5,
     formatter:function(value,row){
     var result = "";
     var editLabel = '<a operFlag="submit_printer_config" href="#" class="easyui-linkbutton" onclick="editLabel(\''+value+'\')" style="padding:5px;"><img style="border-width:0px" src="'+ctx+'/images/button/edit.png" title="编辑标签"/></a>';
     var deleteLabel = '<a operFlag="submit_printer_config" href="#" class="easyui-linkbutton" onclick="deleteLabel(\''+value+'\')" style="padding:5px;"><img style="border-width:0px" src="'+ctx+'/images/button/del.png" title="删除标签"/></a>';
     result = editLabel + deleteLabel;
     return result;
     }
                }
    
    //操作按钮的html 
    
    ]],
     onLoadSuccess:function (data) {
     var dataIds = "";
     var operates = "submit_printer_config";
     var dataType = "";
     var dom = $('#tbLabel');
     var damType = "general";
     parent.setMenuOperate(dataIds, operates, dataType, dom, damType);
     }
    });
    

​

**二、Action、Service、Dao层**

Action层->:

    public String getLabelListWithJson() {
             try {
                 List<LabelVO> labelVOs = (List<LabelVO>) printerBusiness.findLabelListByLabelVOWithPaging(page - 1, rows, null).getData();
                 Integer total = (Integer) printerBusiness.countLabelListByLabelVO(null).getData();
                 PaginationJsonVO paginationJsonVO = new PaginationJsonVO();
                 paginationJsonVO.setRows(labelVOs);
                 paginationJsonVO.setTotal(total);
                 JSONObject result = JSONObject.fromObject(paginationJsonVO, AppConst.JSON_CONFIG);
                 setJsonObjectResult(result);
             } catch (Exception e) {
                 recordExceptionLog(MESSAGE_EXP_ERROR, e);
             }
             return SUCCESS;
        }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->

    @Override
     public BusinessResult findLabelListByLabelVOWithPaging(int start, int perCount, LabelVO term) {
     BusinessResult br = new BusinessResult();
     List<LabelVO> labelVOs = new ArrayList<LabelVO>();
     LabelVO labelVO = null;
     List<Label> labels = labelService.findLabelListByLabelVOWithPaging(start, perCount, term);
     for (int i = 0; i < labels.size(); i++) {
     labelVO = convertLabelToLabelVO(labels.get(i));
     labelVOs.add(labelVO);
     }
     br.setData(labelVOs);
     br.setStatus(BusinessResult.STATUS_SUCCESS);
     return br;
    }
    

​

Service层->

     public List<Label> findLabelListByLabelVOWithPaging(int start, int perCount, LabelVO term) {
            return labelDAO.findLabelListByLabelVOWithPaging(start, perCount, term);
        }
    

​

Dao层，拼装HQL生成Query对象，调用Query对象的list方法返回list数据->

     @SuppressWarnings("unchecked")
         public List<Label> findLabelListByLabelVOWithPaging(int start, int perCount, LabelVO term) {
             String hql = "from Label t";
             hql = repairHqlByLabelVO(hql, term);
             Query query = getSession().createQuery(hql);
             if (start >= 0) {
                 query.setFirstResult(start);
                 query.setMaxResults(perCount);
             }
             return query.list();
        }
    

​

### 查询单个对象数据

**一、Struts配置及前端调用**

Struts:

    <action name="getLabelWithJson" class="org.scbit.tissuebank.config.action.LabelAction" method="getLabelWithJson">
     <result name="success" type="json">
     <param name="root">jsonObjectResult</param>
    </result>
    </action>
    

​

**前端调用:**

在datagrid的id列的column中的formatter中生成对应的调用代码

    function editLabel(id) {
     $.ajax({
       type: "POST",
       dataType:"json",
       url: ctx+'/configJson/getLabelWithJson.action?labelId='+id,
       success: function(data){
            $('#fmEditLabel').find('#ipLabelId').val(data.labelId);
            $('#fmEditLabel').find('#ipLabelType').val(data.labelType);
            $('#fmEditLabel').find('#ipLabelName').val(data.labelName);
            $('#fmEditLabel').find('#ipLabelWidth').val(data.labelWidth);
            $('#fmEditLabel').find('#ipLabelHeight').val(data.labelHeight);
            $('#fmEditLabel').find('#ipLabelHgap').val(data.labelHgap);
            $('#fmEditLabel').find('#ipLabelVgap').val(data.labelVgap);
            $('#fmEditLabel').find('#ipLabelColumn').val(data.labelColumn);
       }
     });
     $('#divEditLabel').dialog('open');
    }
    

​

**二、Action、Service、Dao层**

Action层->:

     public String getLabelWithJson() {
            try {
                LabelVO labelVO = (LabelVO) printerBusiness.findLabelByLabelId(labelId).getData();
                JSONObject result = JSONObject.fromObject(labelVO, AppConst.JSON_CONFIG);
                 setJsonObjectResult(result);
             } catch (Exception e) {
                 recordExceptionLog(MESSAGE_EXP_ERROR, e);
             }
             return SUCCESS;
        }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->

    @Override
     public BusinessResult findLabelByLabelId(String labelId) {
     BusinessResult br = new BusinessResult();
     Label label = labelService.findLabelByLabelId(labelId);
     LabelVO labelVO = convertLabelToLabelVO(label);
     br.setData(labelVO);
     br.setStatus(BusinessResult.STATUS_SUCCESS);
     return br;
    }
    

​

Service层->

      public Label findLabelByLabelId(String id) {
             return labelDAO.findById(id);
        }
    

​

Dao层->

自动继承自基础Dao类

### 查询单个值

**一、Struts配置及前端调用**

Struts:

    <action name="getImportLogContent" class="org.scbit.tissuebank.dataimport.action.DataImportAction" method="getImportLogContent">
    <result name="success" type="json">
         <param name="root">logContent</param>
    </result>
    </action>
    

​

**前端调用:**

    // 显示日志
     function showLogContent(importReportId) {
     $.ajax({
     url : ctx+'/dataImportJson/getImportLogContent.action',
     data : {'importReportId': importReportId},
     // dataType : 'text',
     type : 'post',
     success : function(data) {
     $('#logContent').val(data);
     }
     });
    }
    

​

**二、Action、Service、Dao层**

Action层->:

     public String getImportLogContent() {
        try {
        ImportReportVO importReportVO = (ImportReportVO)                             dataImportBusiness.findImportReportByImportReportId(importReportId).getData();
        String logPath = ServletActionContext.getServletContext().getRealPath("") + "/download/" + importReportVO.getImportLogFileName();
         StringBuffer logContentSb = new StringBuffer();
         TextUtil.readToBuffer(logContentSb, new FileInputStream(logPath));
         logContent = logContentSb.toString();
         } catch (Exception e) {
         logContent = StringUtil.EMPTY;
         }
        return SUCCESS;
    }
    

​

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->

    @Override
     public BusinessResult findImportReportByImportReportId(String importReportId) {
     BusinessResult br = new BusinessResult();
     ImportReport importReport = importReportService.findImportReportByImportReportId(importReportId);
     ImportReportVO importReportVO = convertImportReportToImportReportVO(importReport);
     br.setData(importReportVO);
     return br;
    }
    

​

Service层->

    public ImportReport findImportReportByImportReportId(String importReportId) {
            return importReportDAO.findById(importReportId);
     }
    

​

Dao层->

自动继承自基础Dao类


### 查询非分页列表
**一、Struts配置及前端调用**

Struts:
```xml
<action name="getBarcodePrinters" class="org.scbit.tissuebank.config.action.PrinterAction" method="getBarcodePrinters">
			<result name="success" type="json">
				<param name="root">jsonArrayResult</param>
			</result>
</action>
```


**前端调用:**
```javascript
 $.getJSON(host+"/configJson/getBarcodePrinters.action",function(data){
		 for (var i=0;i<data.length; i++) {
			 console.log(data[i]);
		 }
		 //填充至下拉框
		 $("#printers").combobox('loadData', data);
		 
});
```

**二、Action、Service、Dao层**

Action层->:
```java
/**
     * 得到条码打印机
     * @designer 朱国俊 2012-11-21
     * @developer
     * @modified by
     * @return String
     */
    public String getBarcodePrinters() {
        try {
        	String ugId = getCurrentUser().getOrganizationId(); // 得到ugId
        	BusinessResult businessResult = printerBusiness.findBarcodePrintersByUgId(ugId);
        	if (BusinessResult.STATUS_SUCCESS == businessResult.getStatus()) {
        		List<BarcodePrinterVO> barcodePrinterVOs = (List<BarcodePrinterVO>) businessResult.getData();
        		JSONArray result = JSONArray.fromObject(barcodePrinterVOs);
                setJsonArrayResult(result);
        	}
        } catch (Exception e) {
            recordExceptionLog("异常", e);
        }
        return SUCCESS;
    }
```

Bussiness层获取 BusinessResult,设置BusinessResult中的data数据和status状态->
```java
@Override
	public BusinessResult findBarcodePrintersByUgId(String ugId) {
    	BusinessResult businessResult = new BusinessResult();
    	List<BarcodePrinter> printers = printerService.findBarcodePrinterListByUgId(ugId);
    	List<BarcodePrinterVO> printerVOs = new ArrayList<BarcodePrinterVO>(); // 对象转换
    	for (BarcodePrinter po : printers) {
    	    BarcodePrinterVO vo = barcodePrinterVOconvertTOVO(po);
    	    printerVOs.add(vo);
    	}
    	businessResult.setData(printerVOs);
    	businessResult.setStatus(BusinessResult.STATUS_SUCCESS);
    	return businessResult;
	}
```


Service层->
```java
public List<BarcodePrinter> findBarcodePrinterListByUgId(String ugId) {
    	return printerDAO.findBarcodePrinterListByUgId(ugId);
    }
```

Dao层->
```java
public List<BarcodePrinter> findBarcodePrinterListByUgId(String ugId) {
    	String hql = "from Printer p where p.ugId = "+ ugId;
    	Query query = getSession().createQuery(hql);
    	 return query.list();
    }
```

- - -

# 业务逻辑代码分析

## 首页

1、login.action

2、main.jsp

1、左侧容器

action：viewContainer.action

viewContainer.js

1、绘制tree

Ajax请求:ctx + "/containerJson/getContainerTreeWithJson.action?parent=Organization:0"

顶层容器: findContainerListByOrgId

hql: **select oc.container from OrgContainer oc where oc.userGroup.ugId = :id order by oc.container.containerSeq**

存在父容器的情况: findContainerListByParentId

hql: **from Container c where c.container.containerId = :parentId order by c.containerSeq**

如果是冷冻盒统计其中的样品复份个数

2、树节点的单击响应函数-viewContainer.js:57

2、样品入出还库及单据管理

定位: tissue_in_out_return_library_and_manager_receipt，菜单为HTML格式

TMGRK —贴码管入库

YZGRK -预置管入库

RKDJ -入库单据

RKDJMX-入库单据明细

## 创建新样品

**一、绘制创建新样品的对话框:**

->js/tissue/In/tissueInVirtualTissueCreate.js showVirtualTissuesIn方法

->js/layout/tissueInVirtualCreate.js showVirtualTissueIn方法

->js/layout/tissueInVirtualCreate.js beginCreatePanel方法

--clearTissueInSeesionData方法->tissueAction.java clearTissueInSession方法

清除之前未完成的入库的缓存数据

--loadComboData方法

----getComboData方法

1、获取所属用户组下拉框数据

2、获取样品组下拉框数据

3、获取样品单位下拉框数据

4、获取液体单位下拉框数据

5、获取固体单位下拉框数据

6、获取当前用户相关信息

### 创建按钮
1. addVirtualTBToSession
2. addVirtualTBs
    

### 完成按钮

--createDatagridPanel

创建批量删除按钮和显示创建的样品源信息

--createVirtualTissueInPanel

创建样品源输入和问卷输入界面

-- createTsComboByComp

组装样品源下拉框

— TissueSourceTypeAction : getTissueSourceTypeTreeWithJson 根据机构id和样品源类型父级id查询其下可见的样品源类型（没权限）

-- createVirtualTissueBarcodeComp

添加样品复份量、所属样品组、拥有者【样本的固有属性】

---- createTTCombotreeByCompAddEvent

组装样品类型下拉框

---- getBCAndQuestionsByTissueTypeWithJson
样品入库选择样品类型

**二、点击创建按钮：**

-> 添加样品复份VO到session：TissueAction addTissueBackupVOListToCacheWithJson方法

样品复份VO: tcVOList

-> 从session中读取并存入数据库: TissueAction addTissueAndTissueBackupWithJson方法



## 样品编码配置

1、getIsNotUseBarcodeCheck.action

2、BarcodeCheck.jsp

加号添加按钮HTML:

    <div id = "addDiv" class= "addbarcodeCheck"></div>
    

​

点击响应函数:

     $("#addDiv").click(function (){
     $("#addType").dialog('open');
     var value = $("#cc").combobox('getValue');
         if (value == "customRule" || value == "firmRule") {
     $('#customText').show();
     }
    });
    

​

规则下拉框HTML:

    <div id = "addType" style="padding-top: 20px;text-align: center;">
     <label>规则名称：</label><br>
     <input id = "cc" style="margin-top: 2px"><br>
     <input id = "customText" size = "16" type="text" style="display: none;" class = "easyui-validatebox" required = true>
    </div>
    

​

规则下拉框JS:

     $("#cc").combobox({ 
         url:ctx+'/configJson/getBarcodeCheckTypeListWithJson.action', 
         valueField:'id', 
         textField:'text',
         editable:false,
         onSelect:function(record) {
         if (record.id == "firmRule" || [record.id](http://record.id) == "customRule") {
         $('#customText').show();
         } else {
         $('#customText').hide();
         }
         }
    });
    

​

获取规则下拉框数据:

getBarcodeCheckTypeListWithJson.action

枚举常量:BarcodeCheck.java

    public static final String[] BARCODE_CHECK_TYPE = new String[]{"copysRule:copysRule", "flowRule:flowRule", "tissueSourceRule:tissueSourceRule", "tissueTypeRule:tissueTypeRule", "orgRule:orgRule", "firmRule:firmRule", "customRule:customRule","increaseId:increaseId","tstNum:tstNum"};
    

​

配置文件:

constCodeUi.properties

resourceUi_zh_CN.properties

保存条码规则:

editBarcodeCheckJsonWithJson

更新barcode_check表的bc_rule_detail字段:

->范例:tissueSourceRule:10,tissueTypeRule:4,copysRule:2,increaseId:1

3、BarcodeCheck.js中的 barcodesWithOutCustomRule

如果没有自定义规则的列，则加入如下变量中:

    var barcodesWithOutCustomRule = "copysRule,customRule,firmRule,orgRule,flowRule,tissueTypeRule,tissueSourceRule,increaseId,tstNum";
    

​

## 样品源添加规律性随访

## 添加冰箱

1、添加冰箱的按钮

    parent.openDialog('addFridgeForm', '添加冰箱')
    //打开添加容器对话框
     function openDialog(form, title) {
     type = "";
     $('#'+form).dialog('open');
     $('#'+form).dialog('setTitle', title);
     if (title.indexOf("48") > -1) {
     $("#containerColumn").prop("readOnly",true);
     $("#containerRow").prop("readOnly",true);
     $('#'+form).find('input[type="radio"][value="boxNormal"]').prop("disabled",true);
     $('#'+form).find('input[type="radio"][value="boxCross"]').prop("checked","checked").attr("disabled",false);
     } else if (title.indexOf("96") > -1) {
     $("#containerColumn").attr("readOnly",true);
     $("#containerRow").prop("readOnly",true);
     $('#'+form).find('input[type="radio"][value="boxCross"]').prop("disabled",true);
     $('#'+form).find('input[type="radio"][value="boxNormal"]').prop("checked","checked").attr("disabled",false);
     } else {
         $("#containerColumn").prop("readOnly",false);
         $("#containerRow").prop("readOnly",false);
     $('#'+form).find('input[type="radio"]').prop("disabled",false);
     $('#'+form).find('input[type="radio"][value="boxNormal"]').prop("checked","checked");
     }
     //$('#'+form).form('clear');
     //$('#'+form).focus();
     //显示隐藏掉的控件
     $('#fcc').show();   --
     $('#occ').show();
     $('#icc').show();
     $('#bcc').show();
     initForm();
    }
    
    //设置初始值
    function initForm() {
     $('#fcontainerId').val('');
     $('#ocontainerId').val('');
     $('#icontainerId').val('');
     $('#bcontainerId').val('');
     $('#fcontainerType').val('fridge');
     $('#ocontainerType').val('outsideArea');
     $('#icontainerType').val('insideArea');
     $('#bcontainerType').val('box');
     $('#fcontainerCount').numberbox('setValue', '1');
     $('#ocontainerCount').numberbox('setValue', '1');
     $('#icontainerCount').numberbox('setValue', '1');
     $('#bcontainerCount').numberbox('setValue', '1');
     $('#fcontainerName').val('');
     $('#ocontainerName').val('');
     $('#icontainerName').val('');
     $('#bcontainerName').val('');
     $('#fcontainerNum').val('');
     $('#ocontainerNum').val('');
     $('#icontainerNum').val('');
     $('#fcontainerDesc').val('');
     $('#ocontainerDesc').val('');
     $('#icontainerDesc').val('');
     $('#bcontainerDesc').val('');
     $('#containerColumn').val('12');
     $('#containerRow').val('8');
     $('#fridgeCmb').combobox('select', 'defaultContainer');
     $('#outsideAreaCmb').combobox('select', 'room');
     $('#insideAreaCmb').combobox('select', 'layer');
     $('#fridgeCmb').combobox('enable');
     $('#outsideAreaCmb').combobox('enable');
     $('#insideAreaCmb').combobox('enable');
    }
    

​

2、容器类型下拉框

containerDialog.jsp:

    <select id="fridgeCmb" class="easyui-combobox" validType="length[0,50]"  style="width:155px" onmouseout="clearSpecialCharacter(this)">
    </select>
    

[layout.js][31]:

    //异步读取combobox数据
    
    function loadCmbData(){
     $('#fridgeCmb').combobox({
     url: ctx+'/containerJson/getContainerFormatWithJson.action?containerType=fridgeFormat',
     valueField:'id',
     textField:'text',
     editable: false
     });
     $('#outsideAreaCmb').combobox({
     url: ctx+'/containerJson/getContainerFormatWithJson.action?containerType=outsideAreaFormat',
     textField:'text',
     valueField:'id',
     editable: false
     });
     $('#insideAreaCmb').combobox({
     url: ctx+'/containerJson/getContainerFormatWithJson.action?containerType=insideAreaFormat',
     textField:'text',
     valueField:'id',
     editable: false
     });
    }
    

​

ContainerAction.java中的getContainerFormatWithJson：

读取containerFormat.properties文件中的配置：

fridge:defaultContainer,fridge:nitrogenTank,fridge:horizontalFridge,fridge:verticalFridge,

fridge:freezerSark—冷藏柜,fridge:slicedSark-切片柜,fridge:paraffinSark-石蜡柜

Fridge.java中的枚举常量:

        /** 规格枚举 */
        public static final String[] CONTAINER_FORMAT_FRIDGE_ENUM = new String[]{"defaultcontainer:containerFormatDefaultContainer","verticalFridge:containerFormatVerticalFridge", "horizontalFridge:containerFormatHorizontalFridge", "nitrogenTank:containerFormatNitrogenTank",                                                                         "paraffinSark:containerFormatFridgeParaffinSark", "slicedSark:containerFormatFridgeSlicedSark", "freezerSark:containerFormatFridgeFreezerSark"};
        /** 立式冰箱 */
         public static final String CONTAINER_FORMAT_FRIDGE_VERTICAL_FRIDGE = "verticalFridge";
         /** 卧式冰箱 */
         public static final String CONTAINER_FORMAT_FRIDGE_HORIZONTAL_FRIDGE = "horizontalFridge";
         /** 液氮罐 */
         public static final String CONTAINER_FORMAT_FRIDGE_NITROGEN_TANK = "nitrogenTank";
         /** 石蜡柜 */
         public static final String CONTAINER_FORMAT_FRIDGE_PARAFFIN_SARK = "paraffinSark";
         /** 切片柜 */
         public static final String CONTAINER_FORMAT_FRIDGE_SLICED_SARK = "slicedSark";
         /**  切片柜 */
         public static final String CONTAINER_FORMAT_FRIDGE_FREEZER_SARK = "freezerSark";
         /** defaultContainer */
        public static final String CONTAINER_FORMAT_DEFAULT_CONTAINER = "defaultContainer";
    

​

读取constCodeUi.properties文件中的配置:

containerFormatFridgeParaffinSark = PARAFFIN_SARK

containerFormatFridgeSlicedSark = SLICED_SARK

containerFormatFridgeFreezerSark = FREEZER_SARK

containerFormatDefaultContainer = DEFAULT_CONTAINER

读取resourceUi_zh_CN.properties中的中英文配置:

FREEZER_SARK = \u51B7\u85CF\u67DC

PARAFFIN_SARK = \u77F3\u8721\u67DC

DEFAULT_CONTAINER = \u9ED8\u8BA4\u5BB9\u5668

SLICED_SARK = \u5207\u7247\u67DC

3、点击确定按钮:

    $("#addFridgeForm").dialog({
     modal:true,
     buttons: [{
     text: '确定',
     iconCls: 'icon-ok',
     handler: function() {
     if(!$("#addff").form('validate')) {
     return;
     } else {
     var bool = $('#fcontainerDesc').checkLength({
     min: -1,
     max: 50
     });
     if (!bool) {
     $.messager.alert("提示", "描述内容过长，必须在50字以内!");
     return;
     }
     }
     $('#loadDialog').dialog('open');
     var data = $('#addff').serialize();
     data += "&fridgeVO.containerFormat="+$("#fridgeCmb").combobox('getValue');
     var url = ctx+'/containerJson/addContainer.action?parentId='+containerId;
     if (type == "copy") {
     url = ctx+'/containerJson/copyContainer.action?containerId='+containerId;
     }
     if (type == "edit") {
     url = ctx+'/containerJson/editContainer.action';
     }
     $.ajax({
     url: url,
     type: 'post',
     data: data,
     dataType: 'json',
     success: function(data) {
         $('#loadDialog').dialog('close');
     showSystemMessage(data.status, data.message);
     //等待框
     $('#loadDialog').dialog('close');
     //出现错误时，不关闭对话框
     if (data.status != 'error') {
     //局部刷新树节点
     if (type == "edit" || type == "copy") {
     if (parentNode != null) {
     euTree.tree("reload", parentNode.target);
     } else {
     ifContainerView.location.reload();
     }
     } else {
     if (refreshNode == null) {
     ifContainerView.location.reload();
     } else {
     euTree.tree("reload", refreshNode.target);
                                         euTree.tree("select", refreshNode.target);
     }
     }
     clearData('addff');
     closeDialog('addFridgeForm');
     //显示空白快捷区
     // resetImg();
     }
     //$('#ifContainerView').contents().find("#euContainerTree").tree("reload", refreshNode.target);
     }
     });
     }
     }, {
     text: '取消',
     iconCls:'icon-cancel',
     handler:function(){
         clearData();
     closeDialog('addFridgeForm');
     }
     }]
    });
    

​

4、添加容器--ContainerAction.java中的 addContainer方法:

保存至container表

6、显示冰箱

## 添加规律性随访

addFollowUpWithJson.action  
接收到的数据[范例]:  
intervalNum:2  
intervalUnit:day  
followUpVO.fuNum:3  
followUpVO.tsCaseId:8a8688924719dc9c014724b3094c5eba

## 按样品类型分类的样品

1、enterTissueTypeReport.action

2、viewTissueTypeReport.jsp页面

3、[viewTissueTypeReport.js][32]

绘制treegrid主界面

数据:/statisticsJson/getTissueTypeReportListWithJSON.action

## 入库单查询

1、viewInOrderList

2、viewInOrderList.js

绘制datagrid主界面

数据: /tissueJson/getInOrderListJson.action

hql: SELECT DISTINCT uo.order FROM UgOrder uo, User u WHERE u.userId = uo.order.doOperator

## 入库单明细查询

1、viewInOrderDetail

2、viewInOrderDetail.js

绘制datagrid主界面

数据:/tissueJson/getInOrderDetailJson.action

hql:SELECT DISTINCT uo.order FROM UgOrder uo,User u,Tissue t WHERE u.userId = uo.order.doOperator AND



## 确认出库单扫描界面

1、outTissueOrderDialog.js

    function confirmStorage(id) {
     doId = id;
     $('#ttCheck').datagrid('options').queryParams = {
     'doId':doId
     };
     $('#ttCheck').datagrid('clearSelections');
     interceptUserExpiredAtUnder();
     $('#ttCheck').datagrid('load');
     $('#checkDialog').dialog('open’);  //打开对话框
    }
    
    $('#checkDialog').dialog({
       modal:true,
       title:"出库校验",
       width: 800,
       height: 600,
       resizable:true,
       closed :true,
       buttons: [{ 
             text:'确定', 
             iconCls:'icon-ok', 
             handler:function(){
             if(isCheck()) {
             $.messager.confirm('确认出库单','是否确认该条出库单？',function(r){
             if(r){
         $('#checkDialog').dialog('close');
     showWaiting(top, "正在确认出库单。。。");
             $.ajax({
             url:ctx+'/tissueJson/confirmOutOrderWithJson.action?doId='+ doId,
             type:'post',
             success: function(data){
     closeWaiting(top);
             top.showSystemMessage(data.status,data.message);
             outTissueOrderDatagrid.datagrid('load');
             }
             });
             }
             });
             } else {
             top.showSystemMessage("syserror", "请校验通过再进行下一步");
             }
             }
    
       },{ 
             text:'取消',
             iconCls:'icon-cancel',
             handler:function(){ 
              $('#checkDialog').dialog('close');
             }
         }]
    });
    

​

2、outTissueOrderDialog.jsp( 对话框div )

    <div id = "checkDialog" style="padding: 5px 5px; width: 380px; height:465px;">
     <div id="tool" style="padding: 5px; height: auto; font-size: 12px;">
     <div>
     <table>
     <tr>
     <td><s:text name='SMYB' /> <input type="text" style="width: 120px"  id="keywords" onkeypress="testEnter(event)">
     </td>
     <td>
     <input type="hidden" name="seachclick" value="<s:text name='SS' />" onclick="searchtest()"/> 
     </td>
     </tr>
     </table>
     </div>
     </div>
     <table id = "ttCheck"></table>
    </div>
    

​

3、main.jsp

    <%@ include file="../dialog/outTissueOrderDialog.jsp"%>
    

​



## 分区房间视图

viewAllFridge.jsp

    <action name="enterContainerTissueBackupList" class="org.scbit.tissuebank.tissue.action.TissueAction" method="enterContainerTissueBackupList">
    <result name="view_all_fridge">/page/container/viewModel/viewAllFridge.jsp</result>
    </action>
    

TissueAction.java

     /**
          * 根据用户数据不同进入不同的页面
          * @designer 高占 2013-8-8
          * @developer 高占
          * @modify
          * @return 视图界面
          */
         public String enterContainerTissueBackupList() {
             try {
                 BusinessResult businessResult =  tissueBusiness.findViewModelByUserIdAndContainerId(getCurrentUser(), containerId);
                 if (businessResult.getData() == null) {
                     return "view_all_fridge";
                 }
                 if ((Boolean) businessResult.getData()) {
                     return "view_container";
                 }
             } catch (Exception e) {
                 recordExceptionLog("进入容器", e);
             }
             return "view_tissue";
        }
    

​

## 患者来源管理
1. action:viewTissueSourceType
2. jsp:viewTissueSourceTypeList
```html
<%@ include file="tissueSourceTypeDialog.jsp"%>
```
```html
<iframe id = 'frame'src="<%=request.getContextPath()%>/page/acl/permissions.jsp"></iframe>
```
3. tissueSourceTypeDialog.jsp,permissions.jsp
tissueSourceTypeDialog.jsp:
--样品源编辑的隐藏表单
```html
<div overflow="hidden" id="editTissueSourceType">
	<form id="editTissueSourceTypeForm" method="post">
	<input type="hidden" id="editTstypeId" name="tstVO.tstId" />
		<table>
			<tr>
				<td>样品源类型编号：</td>
				<td><input id="editTstypeNum"  class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="tstVO.tstNum"/></td>
			</tr>
			<tr>
				<td>样品源类型名称：</td>
				<td><input id="editTstypeName" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="tstVO.tstName"/></td>
			</tr>
			<tr>
				<td>所属样品源类型：</td>
				<td><input id="editAllTstype" style="width:150px;" name="tstVO.tstParentId"/></td>
			</tr>
			<tr>
				<td>样品源类型描述：</td>
				<td><textarea id="editTstypeDesc" name="tstVO.tstDesc" style="width:150px;" cols="16" rows="4"></textarea></td>
			</tr>
		</table>
	</form>
</div>
```
permissions.jsp:
--访问许可的隐藏div
```html
<div id = "access" style="overflow: hidden;">
	<form id = "accessFrom" style="width: auto;height: 98%;">
		<input type="hidden" id = "dataId" name = "dataId">
		<table id = "accessData"></table>
	</form>
</div>
```
4. viewTissueSourceTypeList.js

### 访问许可
1. viewTissueSourceTypeList.js
columns中添加了操作按钮的html代码:
```javascript
var accessTsType = '<a id = "'+value+'" operFlag = "access_tissue_source_type" href="#" class="easyui-linkbutton" onclick="access(\''+value+'\',\'config\')" ' +
	        				'style="padding:5px;"><img style="border-width:0px" src="'+ctx+'/images/button/roleOper.png" title="访问许可"/>' +
	        				'</a>';
```
2. onclick的access函数
--显示viewTissueSourceTypeList中
```javascript
dia = $("#frame").contents().find('#access');
form = $("#frame").contents().find('#accessFrom');
data = $("#frame").contents().find('#accessData');
$(dia).show().dialog({
		modal:true,
		title:'访问许可',
		resizable:false,
		width:600,
		height:400,
		buttons:[{
			text:"确定",
			iconCls: 'icon-ok',
			handler:function(){
				var ugs = $('input:checked[flag="access"]');
				var j = 0;
				var ugSelect = "";
				for (var i = 0 ; i < ugs.length; i++) {
					ugSelect +=  ","+$(ugs[i]).attr('name') +":"+$(ugs[i]).val();
					if ($(ugs[i]).val() == "nothing"){
						j ++;
					}
				}
				if (ugs.length > 0) {
					if ( j == ugs.length) {
						$.messager.defaults.ok = "确定";
						return $.messager.alert('警告','不能将所有用户组的权限都设置为不允许！','warning');
					}
				} else {
					$(dia).dialog('close');
				}
				$.ajax({
					url:host+'/'+dataType+'Json/editAclAction.action', 
					data:{ugSelect:ugSelect.substring(1),dataId:dataId},
					type:'post',
					success: function(data){
						top.showSystemMessage(data.status,data.message);
						$(dia).dialog('close');
					}
				});
			}
		},{
			text:"取消",
			iconCls:'icon-cancel',
			handler:function(){
				$(dia).dialog('close');
			}
		}]
	});
```
### 编辑样品
1. tissueSourceTypeDialog.jsp
```html
<div overflow="hidden" id="editTissueSourceType">
	<form id="editTissueSourceTypeForm" method="post">
	<input type="hidden" id="editTstypeId" name="tstVO.tstId" />
		<table>
			<tr>
				<td>样品源类型编号：</td>
				<td><input id="editTstypeNum"  class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="tstVO.tstNum"/></td>
			</tr>
			<tr>
				<td>样品源类型名称：</td>
				<td><input id="editTstypeName" class="easyui-validatebox" style="width:150px;" required="true" validType="length[1,20]" type="text" name="tstVO.tstName"/></td>
			</tr>
			<tr>
				<td>所属样品源类型：</td>
				<td><input id="editAllTstype" style="width:150px;" name="tstVO.tstParentId"/></td>
			</tr>
			<tr>
				<td>样品源类型描述：</td>
				<td><textarea id="editTstypeDesc" name="tstVO.tstDesc" style="width:150px;" cols="16" rows="4"></textarea></td>
			</tr>
		</table>
	</form>
</div>
```
2. viewTissueSourceTypeList.js
columns中添加了操作按钮的html代码:
```javascript
var editTsType = '<a id = "'+value+'" operFlag = "edit_tissue_source_type_info" href="#" onclick="enterTsTypeEdit(\''+ value +'\')">' +
	        				'<img title="编辑样品源类型" style="border-width:0px" src="'+ctx+'/images/button/edit.png" />' +
	        				'</a> ';
```
3. enterTsTypeEdit
```javascript
$('#editTissueSourceType').dialog('open');
```

## 患者下的随访列表
1. action:viewTsFollowUpList
2. jsp:viewTsFollowUpList.jsp
```html
<div overflow="hidden" id="addFu">
		<table>
				<tr>
					<td>添加方案:</td>
					<td><input type="radio" name="fuAddStateText" value="one"  style="width:25px;" onchange="changeType('one')" checked="checked"/>单条随访</td>
					<td><input type="radio" name="fuAddStateText" value="more" style="width:25px;" onchange="changeType('more')"/>规律性随访</td>
				</tr>
		</table>
		<form id="addFuForm" method="#">
			<table id="normal">
				<tr>
					<td>随访时间:</td>
					<td colspan="2"><input id="fuPlan" class="easyui-datebox" required editable="false" style="width:150px;" name="followUpVO.fuPlanShow"/></td>
				</tr>
			</table>
		</form>
		<form id="addreFuForm" method="#">
			<table id="regularity" style="display: none;">
				<tr>
					<td>第一次随访时间:</td>
					<td colspan="2"><input id="fuPlanTime" class="easyui-datebox" required editable="false" style="width:150px;" name="firstFuFlanTime"/></td>
				</tr>
				<tr>
					<td>随访时间间隔:</td>
					<td><input id="timeInterval" class="easyui-validatebox" type="text" style="width:80px;" required validType="length[1,20]" name="intervalNum"/></td>
					<td><input id="fuTimeIntervalUnit" class="easyui-combobox" required editable="false" name="intervalUnit" url="<%=request.getContextPath()%>/js/followUp/timeIntervalUnit.json" valueField="id" textField="text"></input></td>
				</tr>
				<tr>
					<td>随访次数</td>
					<td colspan="2"><input id="fuNum" class="easyui-validatebox" type="text" required editable="false" style="width:150px;" validType="length[1,20]" name="followUpVO.fuNum"/></td>
				</tr>
			</table>
		</form>
		<div style="display:none">
			<table id="tsCaseDiv">
				<tr>
					<td>所属病例:</td>
					<td colspan="2"><input id="tsCaseId" style="width:150px;" name="followUpVO.tsCaseId"/></td>
				</tr>
			</table>
		</div>
	</div>
```
### 添加随访弹出框
1. viewTsFollowUpList.jsp
```html
//按钮
<auth:authorize ifAnyGranted="add_ts_follow_up">
					<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true"  onclick="addFollowUp();">添加随访</a>
			</auth:authorize>
			
//添加随访的对话框			
<div overflow="hidden" id="addFu">
		<table>
				<tr>
					<td>添加方案:</td>
					<td><input type="radio" name="fuAddStateText" value="one"  style="width:25px;" onchange="changeType('one')" checked="checked"/>单条随访</td>
					<td><input type="radio" name="fuAddStateText" value="more" style="width:25px;" onchange="changeType('more')"/>规律性随访</td>
				</tr>
		</table>
		<form id="addFuForm" method="#">
			<table id="normal">
				<tr>
					<td>随访时间:</td>
					<td colspan="2"><input id="fuPlan" class="easyui-datebox" required editable="false" style="width:150px;" name="followUpVO.fuPlanShow"/></td>
				</tr>
			</table>
		</form>
		<form id="addreFuForm" method="#">
			<table id="regularity" style="display: none;">
				<tr>
					<td>第一次随访时间:</td>
					<td colspan="2"><input id="fuPlanTime" class="easyui-datebox" required editable="false" style="width:150px;" name="firstFuFlanTime"/></td>
				</tr>
				<tr>
					<td>随访时间间隔:</td>
					<td><input id="timeInterval" class="easyui-validatebox" type="text" style="width:80px;" required validType="length[1,20]" name="intervalNum"/></td>
					<td><input id="fuTimeIntervalUnit" class="easyui-combobox" required editable="false" name="intervalUnit" url="<%=request.getContextPath()%>/js/followUp/timeIntervalUnit.json" valueField="id" textField="text"></input></td>
				</tr>
				<tr>
					<td>随访次数</td>
					<td colspan="2"><input id="fuNum" class="easyui-validatebox" type="text" required editable="false" style="width:150px;" validType="length[1,20]" name="followUpVO.fuNum"/></td>
				</tr>
			</table>
		</form>
		<div style="display:none">
			<table id="tsCaseDiv">
				<tr>
					<td>所属病例:</td>
					<td colspan="2"><input id="tsCaseId" style="width:150px;" name="followUpVO.tsCaseId"/></td>
				</tr>
			</table>
		</div>
	</div>
```
2.  onclick函数:addFollowUp
```javascript
//添加随访
function addFollowUp() {
	$('#addFu').dialog('open');
}
```
### 添加单条随访
1. action:addFollowUpWithJson
2. 保存至follow_up表相应的数据
随访关联病例：找患者的首次病例
保存随访问卷的答案


### 添加规律性随访
1. action:addFollowUpWithJson
2. post数据
firstFuFlanTime:2015-04-17
intervalNum:2
intervalUnit:月
followUpVO.fuNum:2
根据随访次数生成多条随访记录,每次随访计划时间递增1个随访间隔

### 样品源下病例列表
1. 前端javascript:
```javascript
$a.combobox({
			url : ctx + '/tissueSourceJson/getTSCaseListByTsIdWithJson.action?tsId=' + $('#tissueSourceId').val(),
			valueField : 'tsCaseId',
			textField : 'tsCaseShow',
			required : true,
			editable : false
		});
```
2. action:getTSCaseListByTsIdWithJson
3. 


## 容器样品转移
1. action:enterContainerTissueShift
2. jsp:containerTissueShift.jsp
### 容器转移
1. onclick方法：shiftContainer()
2. action:updateShiftContainer
### 样品转移
1. onclick方法:shiftTissueBackup()

## 系统设置
### 设置空置率

1、main.jsp

    <auth:authorize ifAnyGranted="empty_percent_config">
     <li>
     <a href="#" onclick="addTab('130','设置空置率','${ctx}/config/enterEmptyPercent.action')">
     设置空置率
     </a>
     </li>
    </auth:authorize>
    

权限：

    INSERT INTO `operate` VALUES ('606', '69', 'empty_percent_config', '设置空置率', 'button', '0');
    

​  
2、struts_config.xml

    <!-- 设置空置率 -->
     <action name="enterEmptyPercent" class="org.scbit.tissuebank.config.action.EmptyPercentAction" method="enterEmptyPercentList">
     <result name="success">/page/config/viewEmptyPercent.jsp</result>
    </action>
    

​  
3、EmptyPercentAction.java

    /**
     * 进入空置率设置页面
     * @designer 郭望伟 2013-12-2
     * @developer 郭望伟 2013-12-2
     * @Modified by
     * @return String
     */
     public String enterEmptyPercentList() {
     try {
          BusinessResult result = emptyPercentBusiness.findAllEmptyPercentList();
          emptyPercentVOList = (List<EmptyPercentVO>) result.getData();
     } catch (Exception e) {
          e.printStackTrace();
     }
     return SUCCESS;
    }
    

​

4、viewEmptyPercent.jsp

5、viewEmptyPercent.js

保存:

6、PO:EmptyPercent,VO:EmptyPercentVO
### 打印机管理
#### 打印方案设置

1、进入打印界面

enterDesignPrintSchema

/page/config/designPrintSchema.jsp

方案操作:

基本问题 —configs:对应 ElementDataConfig下的CONFIGS

问卷问题 —queConfigs:

PrintSchemaAction getPrintSchemaTreeWithJson方法

查询 PrintSchema表—左侧查询所有打印方案

2、保存打印方案

editPrintSchemaWithJson

3、使用打印方案

PrinterAction

getCmdPrintNeed

getCmdPrintNeedXmlByPrintIdAndTissueIds

findPrintDatasByTissueIdsAndElements

convertTissueBackupToPrintData

                               //增加if条件
     if(PrintData.TISSUE_LJPOSITION.equals(elementData)){
          printData.setTissueLjPosition(tissueBackup.getTissueLjPosition());
     }
    

​

PrintData类

增加属性及get/set方法

打印纬度为每个复份TissueBackup，所以打印的数据如果在TissueBack表中没有则需要拷贝过来

